<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTG ‚Ä¢ Role Quiz</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../../assets/css/styles.css">

  <style>
    fieldset{border:2px solid var(--border); border-radius:16px; padding:14px; background:rgba(255,255,255,.55)}
    @media (prefers-color-scheme: dark){ fieldset{background:rgba(0,0,0,.35)} }
    legend{font-weight:1000}
    .qNum{color:var(--red); font-weight:1000; margin-right:8px}
    .hint{font-size:13px; opacity:.95; margin-top:8px}
    label.opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border-radius:14px; margin:6px 0;
      cursor:pointer; border:2px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.6);
    }
    @media (prefers-color-scheme: dark){ label.opt{background:rgba(0,0,0,.25)} }
    label.opt:hover{border-color:rgba(212,175,55,.45)}
    input[type="checkbox"]{transform:scale(1.25); margin-top:2px}
    select, input[type="text"]{
      width:100%; padding:12px 12px; border-radius:14px;
      border:2px solid rgba(0,0,0,.15); background:rgba(255,255,255,.92);
      font-size:16px;
    }
    @media (prefers-color-scheme: dark){ select, input[type="text"]{background:rgba(0,0,0,.3); color:var(--ink); border-color:rgba(255,255,255,.15)} }
    .row3{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr}
    @media (max-width:740px){ .row3{grid-template-columns:1fr} }
    .status{padding:10px 12px; border-radius:14px; border:2px solid var(--border); background:rgba(255,255,255,.75); font-weight:900}
    @media (prefers-color-scheme: dark){ .status{background:rgba(0,0,0,.35)} }
    .hidden{display:none}
  </style>
</head>

<body>
<main class="wrap">
  <section class="card">
    <div class="btnRow" style="justify-content:space-between;">
      <div>
        <div class="pixel" style="font-size:14px;">PTG Role Quiz üéØ</div>
        <div class="small">Most questions: <strong>pick 1‚Äì3</strong> ‚úÖ (you‚Äôll see it on each line).</div>
      </div>
      <div class="btnRow">
        <a class="btn" href="../../index.html">üè† Home</a>
        <button class="btn" id="musicToggle" type="button" aria-pressed="true">üîá Music Off</button>
      </div>
    </div>
  </section>

  <form id="quizForm" class="card" novalidate>
    <h1 class="pixel" style="margin:0 0 10px 0;">Find your lane</h1>

    <!-- Q1 split -->
    <fieldset>
      <legend><span class="qNum">Q1</span> Basics</legend>
      <div class="row3" style="margin-top:10px;">
        <div>
          <label class="small" for="name">First name</label>
          <input id="name" name="name" type="text" placeholder="Example: Jordan" required />
        </div>
        <div>
          <label class="small" for="ageRange">Age range</label>
          <select id="ageRange" name="ageRange" required>
            <option value="" selected disabled>Pick one‚Ä¶</option>
            <option value="u13">Under 13</option>
            <option value="13-15">13‚Äì15</option>
            <option value="16-17">16‚Äì17</option>
            <option value="18-24">18‚Äì24</option>
            <option value="25-34">25‚Äì34</option>
            <option value="35plus">35+</option>
          </select>
        </div>
        <div>
          <label class="small" for="gender">Gender</label>
          <select id="gender" name="gender" required>
            <option value="" selected disabled>Pick one‚Ä¶</option>
            <option value="M">M</option>
            <option value="F">F</option>
            <option value="NA">N/A</option>
          </select>
        </div>
      </div>
      <div class="hint">No last names. Keep it simple ‚úÖ</div>
    </fieldset>

    <!-- Q2..Q9: checkbox pick 1-3, scrambled via JS -->
    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q2</span> What sounds most like you? <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q2" value="CEO"> Big calls + protect the mission.</label>
      <label class="opt"><input type="checkbox" name="q2" value="GM"> Run the day + keep the floor smooth.</label>
      <label class="opt"><input type="checkbox" name="q2" value="COMM"> Events + people + community vibe.</label>
      <label class="opt"><input type="checkbox" name="q2" value="TECH"> Tech + systems + making it work.</label>
      <label class="opt"><input type="checkbox" name="q2" value="CASH"> Front desk + check-in/out + fairness.</label>
      <label class="opt"><input type="checkbox" name="q2" value="MEMBER"> Safe fun place + support the culture.</label>
      <div class="hint" data-live="q2"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q3</span> If conflict pops off, you‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q3" value="OPS"> Step in, calm it, set the boundary.</label>
      <label class="opt"><input type="checkbox" name="q3" value="CASH"> Keep it polite and moving.</label>
      <label class="opt"><input type="checkbox" name="q3" value="TECH"> Fix the system so it stops repeating.</label>
      <label class="opt"><input type="checkbox" name="q3" value="COMM"> Reset the vibe + reconnect people.</label>
      <label class="opt"><input type="checkbox" name="q3" value="GM"> Handle it in real time like a floor lead.</label>
      <label class="opt"><input type="checkbox" name="q3" value="MEMBER"> I avoid drama ‚Äî I want peace.</label>
      <div class="hint" data-live="q3"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q4</span> Your ‚Äúextra effort‚Äù looks like‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q4" value="OPS"> Clean, organize, fix what‚Äôs broken.</label>
      <label class="opt"><input type="checkbox" name="q4" value="COMM"> Host, welcome, include people.</label>
      <label class="opt"><input type="checkbox" name="q4" value="TECH"> Help with setups + teach.</label>
      <label class="opt"><input type="checkbox" name="q4" value="CASH"> Check-ins + questions + fairness.</label>
      <label class="opt"><input type="checkbox" name="q4" value="CEO"> Take responsibility when it matters.</label>
      <label class="opt"><input type="checkbox" name="q4" value="MEMBER"> Show up consistent + follow rules.</label>
      <div class="hint" data-live="q4"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q5</span> A ‚Äú10/10 visit‚Äù needs‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q5" value="CASH"> Friendly staff + quick help.</label>
      <label class="opt"><input type="checkbox" name="q5" value="OPS"> Clean space + smooth systems.</label>
      <label class="opt"><input type="checkbox" name="q5" value="COMM"> Strong vibe + respect.</label>
      <label class="opt"><input type="checkbox" name="q5" value="TECH"> Great setup: controllers/updates/accounts.</label>
      <label class="opt"><input type="checkbox" name="q5" value="CEO"> Clear fairness rules for everyone.</label>
      <div class="hint" data-live="q5"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q6</span> PTG game plan should prioritize‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q6" value="GM"> Big crowd games (easy to jump in).</label>
      <label class="opt"><input type="checkbox" name="q6" value="COMM"> Community games (events/co-op).</label>
      <label class="opt"><input type="checkbox" name="q6" value="OPS"> Organized library rules + updates.</label>
      <label class="opt"><input type="checkbox" name="q6" value="MEMBER"> Whatever people want most (flex).</label>
      <label class="opt"><input type="checkbox" name="q6" value="CEO"> Balanced plan that matches the mission.</label>
      <div class="hint" data-live="q6"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q7</span> Rules should be‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q7" value="OPS"> Strict + consistent.</label>
      <label class="opt"><input type="checkbox" name="q7" value="CASH"> Strict but fair (explain first).</label>
      <label class="opt"><input type="checkbox" name="q7" value="COMM"> Chill, step in when needed.</label>
      <label class="opt"><input type="checkbox" name="q7" value="MEMBER"> Mostly chill.</label>
      <label class="opt"><input type="checkbox" name="q7" value="GM"> Different by age group/time.</label>
      <div class="hint" data-live="q7"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q8</span> Community move that matters most‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q8" value="COMM"> Weekly events that pull people in.</label>
      <label class="opt"><input type="checkbox" name="q8" value="CEO"> Leaders protect culture + safety.</label>
      <label class="opt"><input type="checkbox" name="q8" value="TECH"> Tech workshops (accounts/safety/basics).</label>
      <label class="opt"><input type="checkbox" name="q8" value="CASH"> Customer service like family.</label>
      <label class="opt"><input type="checkbox" name="q8" value="OPS"> Consistency every day.</label>
      <label class="opt"><input type="checkbox" name="q8" value="MEMBER"> A cool place to belong (with structure).</label>
      <div class="hint" data-live="q8"></div>
    </fieldset>

    <fieldset data-min="1" data-max="3">
      <legend><span class="qNum">Q9</span> How you lead/support‚Ä¶ <span class="small">(pick 1‚Äì3)</span></legend>
      <label class="opt"><input type="checkbox" name="q9" value="CEO"> Set vision + protect values.</label>
      <label class="opt"><input type="checkbox" name="q9" value="GM"> Coordinate people + solve in real time.</label>
      <label class="opt"><input type="checkbox" name="q9" value="OPS"> Build checklists + standards.</label>
      <label class="opt"><input type="checkbox" name="q9" value="COMM"> Build community + inclusion.</label>
      <label class="opt"><input type="checkbox" name="q9" value="TECH"> Handle tech + teach.</label>
      <label class="opt"><input type="checkbox" name="q9" value="CASH"> Calm front desk clarity.</label>
      <label class="opt"><input type="checkbox" name="q9" value="MEMBER"> Support as member + feedback.</label>
      <div class="hint" data-live="q9"></div>
    </fieldset>

    <!-- ‚úÖ UPDATED BUTTON ROW: Submit becomes Email action; add Copy BEFORE Reset -->
    <div class="btnRow" style="margin-top:12px;">
      <!-- Was type="submit" ‚Äî now email flow button -->
      <button class="btn primary" id="btnRevealEmail" type="button">üéØ Reveal my role (Email)</button>

      <!-- New copy button BEFORE reset -->
      <button class="btn" id="btnCopy" type="button">üìã Copy Answers</button>

      <!-- Reset stays last -->
      <button class="btn" type="reset">Reset</button>
    </div>

    <p class="small" style="margin-top:10px;">
      GitHub Pages fallback: Email + Copy always work ‚úÖ. Cloudflare Submit is disabled for now.
    </p>
  </form>

  <section id="resultCard" class="card hidden" aria-live="polite">
    <h2 class="pixel" style="margin:0 0 10px 0;">Your result</h2>
    <div class="card" style="margin:0 0 12px 0;">
      <div style="font-weight:1000;font-size:26px;" id="resultRole">‚Äî</div>
      <div class="small" id="resultSubtitle"></div>
      <p id="resultDesc" style="margin:8px 0 0 0;"></p>
    </div>

    <details class="card" style="margin:0;">
      <summary style="font-weight:1000;cursor:pointer;">Show score breakdown</summary>
      <ul id="resultScores"></ul>
    </details>

    <!-- ‚úÖ UPDATED RESULT BUTTONS:
         Keep Email + Download, replace Cloudflare Submit with Copy Result
    -->
    <div class="btnRow" style="margin-top:12px;">
      <button class="btn" id="btnEmail" type="button">üìß Email</button>
      <button class="btn" id="btnDownload" type="button">‚¨áÔ∏è Download JSON</button>
      <button class="btn" id="btnCopyResult" type="button">üìã Copy Result</button>
      <!-- Cloudflare Submit disabled for now -->
      <!-- <button class="btn green" id="btnSubmit" type="button">‚úÖ Submit (Cloudflare)</button> -->
    </div>

    <div id="submitStatus" class="status" style="margin-top:10px;">Ready.</div>
  </section>

  <audio id="bgMusic" src="../../assets/audio/music0.mp3" loop preload="none"></audio>
</main>

<script>
  // ‚úÖ Replace with your Worker URL AFTER deploy (example):
  // window.PTG_SUBMIT_ENDPOINT = "https://ptg-role-quiz-api.YOURNAME.workers.dev/submit";
  // For now: intentionally blank (Cloudflare disabled)
  window.PTG_SUBMIT_ENDPOINT = "";
  // Optional: set secret if you use one in Cloudflare
  window.PTG_SUBMIT_SECRET = "";
</script>

<!-- Keep app.js (it calculates role + fills result card).
     We are NOT removing it; we are using it to produce the result,
     then emailing instead of Cloudflare. -->
<script src="./app.js"></script>

<script>
  /***********************************************************************
   * MUSIC TOGGLE (UNCHANGED)
   ***********************************************************************/
  const musicToggle = document.getElementById("musicToggle");
  const bgMusic = document.getElementById("bgMusic");
  let muted = localStorage.getItem("ptg_rolequiz_muted");
  muted = (muted === null) ? "1" : muted;

  function syncMusic(){
    const isMuted = muted === "1";
    musicToggle.textContent = isMuted ? "üîá Music Off" : "üîä Music On";
    musicToggle.setAttribute("aria-pressed", isMuted ? "true" : "false");
  }
  syncMusic();

  musicToggle.addEventListener("click", async () => {
    const isMuted = muted === "1";
    if (isMuted){
      try{ await bgMusic.play(); muted="0"; }
      catch{ muted="1"; alert("Tap again ‚Äî browser needs interaction for audio."); }
    } else {
      bgMusic.pause(); muted="1";
    }
    localStorage.setItem("ptg_rolequiz_muted", muted);
    syncMusic();
  });
</script>

<script>
  /***********************************************************************
   * ‚úÖ EMAIL + COPY FLOW (NO CLOUDFLARE)
   *
   * Requirements you gave:
   * - Submit button should send email (not Cloudflare) for now
   * - Add a Copy button BEFORE the Reset button
   *
   * Locked settings:
   * Email to: changethewrld@outlook.com
   * Subject: PTG Role Quiz Results
   *
   * Behavior:
   * 1) "Reveal my role (Email)" triggers the same logic as form submit (app.js),
   *    then opens an email draft containing answers + displayed result.
   * 2) "Copy Answers" copies only the form answers.
   * 3) "Copy Result" copies answers + displayed result (after reveal).
   ***********************************************************************/

  const TO_EMAIL = "changethewrld@outlook.com";
  const SUBJECT  = "PTG Role Quiz Results";

  const quizForm = document.getElementById("quizForm");
  const btnRevealEmail = document.getElementById("btnRevealEmail");
  const btnCopy = document.getElementById("btnCopy");
  const btnCopyResult = document.getElementById("btnCopyResult");

  const resultCard = document.getElementById("resultCard");
  const submitStatus = document.getElementById("submitStatus");

  function collectFormText(formEl){
    const fd = new FormData(formEl);
    const lines = [];
    for (const [key, value] of fd.entries()) {
      const k = String(key || "").trim();
      const v = String(value || "").trim();
      if (!k) continue;
      lines.push(`${k}: ${v}`);
    }
    return lines.join("\n");
  }

  function collectDisplayedResultText(){
    const role = (document.getElementById("resultRole")?.textContent || "").trim();
    const subtitle = (document.getElementById("resultSubtitle")?.textContent || "").trim();
    const desc = (document.getElementById("resultDesc")?.textContent || "").trim();

    const scoresEl = document.getElementById("resultScores");
    const scores = [];
    if (scoresEl) {
      scoresEl.querySelectorAll("li").forEach(li => {
        const t = (li.textContent || "").trim();
        if (t) scores.push(t);
      });
    }

    let out = [];
    out.push("RESULT");
    out.push("======");
    out.push(`role: ${role || "‚Äî"}`);
    if (subtitle) out.push(`subtitle: ${subtitle}`);
    if (desc) out.push(`desc: ${desc}`);
    if (scores.length) {
      out.push("");
      out.push("SCORES");
      out.push("======");
      scores.forEach(s => out.push(`- ${s}`));
    }
    return out.join("\n");
  }

  async function copyToClipboard(text){
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return;
    }
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  function openMailClient(to, subject, body){
    const mailto =
      `mailto:${encodeURIComponent(to)}` +
      `?subject=${encodeURIComponent(subject)}` +
      `&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  }

  function buildEmailBody(){
    const answers = collectFormText(quizForm);
    const resultText = collectDisplayedResultText();

    const header = [
      "PTG ROLE QUIZ",
      "===========",
      `timestamp: ${new Date().toLocaleString()}`,
      ""
    ].join("\n");

    return [
      header,
      "ANSWERS",
      "=======",
      answers || "(no answers found)",
      "",
      resultText
    ].join("\n");
  }

  // ‚úÖ Copy Answers button (raw form answers)
  btnCopy.addEventListener("click", async () => {
    const text = collectFormText(quizForm);
    try {
      await copyToClipboard(text);
      btnCopy.textContent = "‚úÖ Copied!";
      if (submitStatus) submitStatus.textContent = "Copied answers to clipboard üíæ";
    } catch(e){
      if (submitStatus) submitStatus.textContent = "Copy failed on this browser. Try manual select + copy.";
    }
    setTimeout(() => (btnCopy.textContent = "üìã Copy Answers"), 1400);
  });

  // ‚úÖ Copy Result button (answers + displayed result)
  btnCopyResult.addEventListener("click", async () => {
    const text = buildEmailBody();
    try {
      await copyToClipboard(text);
      btnCopyResult.textContent = "‚úÖ Copied!";
      if (submitStatus) submitStatus.textContent = "Copied answers + result to clipboard üíæ";
    } catch(e){
      if (submitStatus) submitStatus.textContent = "Copy failed on this browser. Try manual select + copy.";
    }
    setTimeout(() => (btnCopyResult.textContent = "üìã Copy Result"), 1400);
  });

  // ‚úÖ Reveal + Email:
  // We trigger app.js logic by dispatching a submit event on the form
  // (app.js likely listens to submit).
  // Then we open the mail client with answers + result.
  btnRevealEmail.addEventListener("click", async () => {
    // Basic validation for required Q1 fields
    const name = document.getElementById("name");
    const ageRange = document.getElementById("ageRange");
    const gender = document.getElementById("gender");

    if (!name.value.trim() || !ageRange.value || !gender.value) {
      if (submitStatus) submitStatus.textContent = "‚ö†Ô∏è Fill Q1 (name + age range + gender) first.";
      if (name && !name.value.trim()) name.focus();
      else if (ageRange && !ageRange.value) ageRange.focus();
      else if (gender && !gender.value) gender.focus();
      return;
    }

    // Trigger the same flow as pressing "submit"
    const submitEvent = new Event("submit", { bubbles: true, cancelable: true });
    quizForm.dispatchEvent(submitEvent);

    // Wait a tiny bit so app.js can populate result fields
    setTimeout(async () => {
      // Safe fallback: ensure card is visible
      if (resultCard && resultCard.classList.contains("hidden")) {
        resultCard.classList.remove("hidden");
      }

      const body = buildEmailBody();

      // Optional: copy automatically before opening email (clutch fallback)
      try { await copyToClipboard(body); } catch(e){}

      if (submitStatus) submitStatus.textContent = "Opening email draft‚Ä¶ üìß";
      openMailClient(TO_EMAIL, SUBJECT, body);
    }, 60);
  });

  // Optional hard block for Enter-to-submit:
  // If you want to prevent any form submit outside our button, uncomment below.
  //
  // quizForm.addEventListener("submit", (e) => e.preventDefault());
  //
</script>

</body>
</html>
